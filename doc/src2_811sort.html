<HTML WIDTH=70% XPOS=right>
<HEAD>
<TITLE>
Extended Sort Functions
</TITLE>
</HEAD>

<BODY TEXT="#000000" BGCOLOR="#FFFFFF" LINK="#0000AA" VLINK="#777777">
The default WPS sort functions are a mess, and I suppose IBM knows that, since
they have hardly documented them at all.

<P>So here's what I found out.

<P>Normally, the WPS relates sort criteria to <B>object details.</B> That is, to
implement a sort criterion, you have to have a corresponding object detail, as
defined in the <CODE>wpclsQueryDetailsInfo</CODE> and <CODE>wpQueryDetailsData</CODE>
methods. This is superficially explained in the "WPS Programming Guide", in
"Object Criteria: Details methods".

<P>There are many more object details than those shown in folder Details
views. I have counted 23 here (but your results may vary), and since there
are only 13 columns in Details view, there should be
about 10 invisible details. (Side note: You can view all of them by turning
to the "Include" page of any folder and pressing the "Add..." button.)

<P>Most of the details
are defined in WPFileSystem's override of <CODE>wpclsQueryDetailsInfo</CODE>,
and if certain sort flags are specified there (even when the details column is
never visible), the WPS will make this detail available as a sort criterion.
That is, if such a sort flag is set for an object detail,
the WPS inserts the column title in the "Sort" submenu,
shows it on the "Sort" page, and sets some corresponding comparison function
for the folder containers automatically.

<P>This works beautifully for "real" subclasses of default WPS classes. For example,
you can create some subclass of WPDataFile, e.g. "WPAddress" for storing addresses,
define new object details for that class, set the "folder sort class" of a folder to
WPAddress, and you can then sort the folder according to addresses automatically.

<P>So, in theory, the whole details concept is great. You add new details to
a class, and the WPS can automatically sort, display the details, and even
set the "Include" options for folder accordingly.

<P>But unfortunately, all the details/include/sort stuff is yet another example
of another great IBM concept which was only half implemented.
I have found out the hard way that <B>XWorkplace cannot use this approch</B>
to extend the default sort criteria. This is for the following reasons (believe
me, I've tried all of the following):

<OL><LI>It is impossible to add new default details to a replacement class of
WPFileSystem.
Even if WPFileSystem is replaced with another class, <CODE>wpQueryFldrSortClass</CODE> and
<CODE>wpQueryFldrDetailsClass</CODE> do not return the replacement class object,
but the original WPFileSystem class object. I have then tried to replace these two methods
too, and details/sorting would still not always work. There seem to be some ugly
kludges in the WPS internally.

<P><LI>Apparently, two sort criteria ("Name" and "Type") do <I>not</I> correspond to
any details columns. Normally, sort criteria are specified by passing the corresponding
details column to a sort function (see <CODE>wpIsSortAttribAvailable</CODE>, for
example). However, these two criteria have indices of "-2" and "-1", so there seems
to be some hard-coded special case check in the WPS again. The "Type" criterion is
even available when WPObject is selected as the folder sort class, but WPObject
does not define that detail. So who knows.

<P><LI>The documentation for <CODE>CLASSFIELDINFO</CODE> is incomplete and partly
incorrect. I have tried to specify new sort functions in there, and the WPS would
just hang. Apparently the function prototypes are not correct, because my
own comparison function
would never reach its first instruction before the hang.

<P><LI>The <CODE>wpQueryFldrSort</CODE> and <CODE>wpSetFldrSort</CODE> methods
are completely obscure. They are prototyped using a <CODE>PVOID</CODE> parameter, and the
documentation says this should point to a <CODE>SORTFASTINFO</CODE> structure. But
for one, this structure is defined nowhere in the headers, and even more importantly,
the data passed to these methods does not correspond to the description in the
WPS reference. The first field in the structure is definitely no sort function.
So we have one more mystery there.

<P><LI>The most important limitation was however that there are no default settings
for sorting. The default sort criterion is always set to "Name", and "Always sort"
is always off. This is hard-coded into WPFolder and cannot be changed. There is not
even an instance method for querying or setting the "Always sort" flag, let alone
a class method for the default values. The only documented thing is the
<CODE>ALWAYSSORT</CODE> setup string.

</OL>Besides, the whole concept is so complicated that I only understood it now after
having debugged all the related methods for several days. I don't think many users
appreciate the flexibility of that concept or even know what "sort classes" or
"details classes" are about,
even though there may be certain WPS classes that use this concept.

<P><B>The XWorkplace approach.</B> It's basically a "brute force" method. XWorkplace lets
the WPS add the default sort features to context menus as usual,
then adds its own, and just
intercepts <I>all</I> the menu ID's in <CODE>wpMenuItemSelected</CODE>.
<P>I have then
written a complete new set of sort comparison functions (in <CODE>cnrsort.*</CODE>)
which do the job for the various sort criteria. These are regular <I>container</I>
comparison functions, as used with the CM_SORTRECORD message, thus bypassing
all the information in the WPS's <CODE>CLASSFIELDINFO</CODE> structures.
So it's not the WPS at all any more which does the sorting, but
XWorkplace, and XWorkplace uses its own set of global and instance settings
for all this. See
<CODE>fdrSetFldrCnrSort</CODE> in <CODE>src\filesys\folder.c</CODE> for how this is done.

<P>As you know, XWorkplace replaces the "Sort" page in folder settings notebooks
altogether too so we can set the new instance settings.

<P>In addition, XWorkplace overrides the <CODE>wpSetFldrSort</CODE> method, which
apparently gets called every time the WPS tries to sort a folder. That is, normally,
if one
of the "Sort" menu items would get called, but these are intercepted already by
XWorkplace. The override is still needed though because the WPS calls that method frequently
when "Always sort" is on also, e.g. when you rename a file.

<P>Finally, there's a real neat hack to get access to the internal folder sort settings,
i.e. the settings that reside in the memory allocated by the original WPFolder class.
In <CODE>wpRestoreData</CODE>, which gets called when an object is awakened, WPFolder
always attempts to restore its folder sort settings from the instance settings.

<P>Since
the caller always passes a block of memory to which <CODE>wpRestoreData</CODE> should
write if the data was found, we can intercept that pointer and store it in XWorkplace's
instance data. We can therefore manipulate the "Always sort" flag also.

<P>BTW, this can be used as a general approach to get access to WPS-internal data, if
a corresponding <CODE>ulKey</CODE> exists. Just override <CODE>wpRestoreData</CODE>
(or the other restore methods) and check for what keys they get called. Most of them
are declared in <CODE>wpfolder.h</CODE> in the Toolkit headers.
<BR>
</BODY>
</HTML>

